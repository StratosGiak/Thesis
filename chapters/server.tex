\documentclass[../thesis.tex]{subfiles}

\begin{document}

Η φύση της εφαρμογής επιβάλλει την ύπαρξη ενός κεντρικού server ο οποίος συντονίζει τις διάφορες λειτουργίες.
Οι πεζοί και οι οδηγοί χρειάζεται να επικοινωνούν μεταξύ τους σε πραγματικό χρόνο, και στην επικοινωνία αυτή μεσολαβεί ο server: ο κάθε χρήστης στέλνει όλα τα μηνύματα του στον server, ο server με τη σειρά του τα επεξεργάζεται αλλάζοντας αναλόγως την εσωτερική του κατάσταση, και έπειτα προωθεί περαιτέρω μηνύματα στους απαραίτητους χρήστες.

Για την εφαρμογή του server χρησιμοποιήσαμε το Node.js.
Η εφαρμογή του server αποτελείται από δύο υπηρεσίες:
\begin{itemize}
    \item την κύρια υπηρεσία API που χειρίζεται όλη την εσωτερική λογική και με την οποία οι χρήστες επικοινωνούν
    \item την υπηρεσία που χειρίζεται τα αρχεία πολυμέσων, και συγκεκριμένα τις εικόνες που ανεβάζουν οι χρήστες
\end{itemize}
Ο διαχωρισμός αυτός έγινε καθώς διαμερίζοντας τον server σε ειδικευμένα μέρη μπορούμε να πετύχουμε καλύτερη επίδοση.
Αποθηκεύοντας ξεχωριστά όλα τα αρχεία πολυμέσων (αρχεία σχετικά μεγάλου μεγέθους) και μεταφέροντας την αρμοδιότητα διαχείρισής τους σε άλλο server, ελαφραίνουμε τον φόρτο από την κύρια υπηρεσία μας και πετυχαίνουμε μικρότερο latency.

Για τον web server χρησιμοποιήσαμε το Nginx, κυρίως ως reverse proxy.
Το Nginx βρίσκεται "μπροστά" από το Node.js και δέχεται πρώτο όλα τα requests που φτάνουν στον server.
Μέσω ενός reverse proxy, ανακατευθύνουμε τα requests στη θύρα της υπηρεσίας API ή της υπηρεσίας πολυμέσων ανάλογα με το URL, καταφέρνοντας με αυτόν τον τρόπο να έχουμε το ίδιο domain και για τους δύο server.
Ο server Nginx είναι επίσης υπεύθυνος για την αποστολή των στατικών αρχείων στον χρήστη (στην προκειμένη περίπτωση αρχεία εικόνων), μία λειτουργία στην οποία υπερέχει του Node.js ως προς την ταχύτητα.
Τέλος, μέσω του Nginx ενσωματώνουμε την κρυπτογράφηση SSL/TLS για την ασφαλή επικοινωνία των χρηστών με τον server μέσω HTTPS, με πιστοποιητικό που λαμβάνουμε από τη γνωστή αρχή πιστοποίησης \textit{Let's Encrypt}.

Τα δεδομένα των χρηστών πρέπει να συγχρονίζονται μεταξύ των συσκευών στις οποίες συνδέονται, επομένως είναι απαραίτητη η αποθήκευσή τους στον server.
Για αυτόν τον σκοπό χρησιμοποιούμε μία σχεσιακή βάση δεδομένων MySQL.
Η βάση αποτελείται από δύο tables, ένα για τις πληροφορίες των χρηστών και ένα για τα οχήματα.
Συγκεκριμένα οι πληροφορίες που συγκρατούνται στη βάση για τον κάθε χρήστη αποτελούνται από τον αριθμό μητρώου του (ο οποίος λειτουργεί ως το στοιχείο ταυτοποίησης), τη βαθμολογία του, και προαιρετικά μία φωτογραφία.
Όσον αφορά τα οχήματα, αποθηκεύεται ο ΑΜ του χρήστη στον οποίο αυτό ανήκει, το μοντέλο, και ο αριθμός πινακίδας του, ενώ προαιρετικά μπορεί να συμπεριληφθεί το χρώμα και μία φωτογραφία.
Έχοντας αποθηκεύσει τα δεδομένα στη βάση, κάθε φορά που ένας χρήστης συνδέεται στην εφαρμογή τα υπάρχοντα στοιχεία του στέλνονται από τον server στη συσκευή του, ενώ ό,τι νέα στοιχεία προκύψουν στέλνονται στον server για την ανανέωση της βάσης.

Η επικοινωνία client-server επιτυγχάνεται μέσα από την τεχνολογία WebSocket.
Ο χρήστης της εφαρμογής, αφού ταυτοποιηθεί ως φοιτητής από την υπηρεσία της σχολής, ανοίγει σύνδεση WebSocket με τον server.
Η σύνδεση αυτή διαρκεί για όλη τη διάρκεια της συνεδρίας, και τερματίζεται μόλις ο χρήστης αποσυνδεθεί.
Το πρωτόκολλο WebSocket χρησιμοποιήθηκε καθώς αξιολογήθηκε ως το καταλληλότερο για τις απαιτήσεις της εφαρμογής ως προς τη real-time επικοινωνία.
Τα WebSockets υπερέχουν τόσο της κλασσικής τεχνολογίας του long polling, καθώς παρέχουν άμεση και αμφίδρομη επικοινωνία με μικρές καθυστερήσεις, αλλά και της τεχνολογίας WebRTC, καθώς προσφέρουν εγγυήσεις για την επιτυχή αποστολή των πακέτων χωρίς σφάλματα.

Όπως αναφέραμε προηγουμένως, το backend αποτελείται από δύο ανεξάρτητα μέρη, έναν κλασσικό HTTP server για τα αρχεία πολυμέσων, και έναν WebSocket server για το API.
Ο media server ανταποκρίνεται απλά σε GET/POST/DELETE requests με τον ευνόητο τρόπο, επιστρέφοντας/ανεβάζοντας/διαγράφοντας αρχεία εικόνων αντιστοίχως.
Το μόνο στοιχείο που αξίζει να σημειωθεί είναι η ύπαρξη ελέγχων για την προστασία έναντι κακόβουλων ενεργειών, συγκεκριμένα η ύπαρξη ανώτατου ορίου των 2MB για τα αρχεία που ανεβάζονται\footnote{Στην πραγματικότητα το όριο των 2MB επιβάλλεται από το Nginx για όλα τα αιτήματα που φτάνουν στον server}, η απαγόρευση αρχείων που δεν έχουν τύπο εικόνας PNG/JPEG, και φυσικά η απαγόρευση ανεβάσματος αρχείων από χρήστες που δεν είναι πιστοποιημένοι.
Η λειτουργία του API server είναι πιο ενδιαφέρουσα.
Για τη σύνδεση μέσω WebSocket απαιτείται πρώτα η αποστολή ενός HTTP upgrade request από τον client προς τον server, ακολουθόμενη από την αποδοχή της αίτησης από τον server (opening handshake).
Σε αυτή την εναρκτήρια αίτηση, ο χρήστης στέλνει με τη μορφή JWT (JSON Web Token) τα στοιχεία της ταυτότητάς του όπως αυτά παραχωρήθηκαν από τον Identity Provider της σχολής, και ο server ελέγχει την εγκυρότητά τους.
Αν για οποιονδήποτε λόγο ο server κρίνει την ταυτότητα του χρήστη ως μη έγκυρη\footnote{Η ταυτότητα ενός χρήστη κρίνεται ως μη έγκυρη αν το JWT έχει λήξει, αν δεν περιέχει όλα τα ταυτοποιητικά στοιχεία που είναι απαραίτητα, αν η υπογραφή του δεν αντιστοιχεί στον Identity Provider της σχολής, ή αν το JWT απουσιάζει εντελώς}, τότε η σύνδεση τερματίζεται αμέσως.
Αν η ταυτότητα του χρήστη είναι έγκυρη, τότε η σύνδεση επιτυγχάνεται και ο χρήστης έχει πλέον τη δυνατότητα να επικοινωνήσει με το API του server μέσω της εφαρμογής.
Κατά την επιτυχή σύνδεση του χρήστη, ο server αρχικά αναζητά τον χρήστη στην βάση δεδομένων.
Αν ο χρήστης συνδέεται στην εφαρμογή για πρώτη φορά και επομένως δεν υπάρχει ο αντίστοιχος λογαριασμός στη βάση, τότε δημιουργείται ένας νέος άδειος λογαριασμός· διαφορετικά ο server διαβάζει τα αποθηκευμένα στοιχεία από τη βάση και τα στέλνει πίσω στον χρήστη.
Από το σημείο αυτό και πέρα, ο server αναμένει την αποστολή μηνυμάτων από την εφαρμογή, εκτελώντας τις ανάλογες λειτουργίες κατά την λήψη τους, και στέλνοντας ενδεχομένως άλλα μηνύματα πίσω στον χρήστη.
Το κάθε μήνυμα που ανταλλάσσεται μεταξύ εφαρμογής και server είναι ένα αντικείμενο JSON το οποίο περιέχει δύο πεδία: τον τύπο και τα δεδομένα.
Ο τύπος του κάθε μηνυμάτος υποδεικνύει την ενέργεια που επιθυμεί να λάβει ο χρήστης, και ανήκει σε μία προκαθορισμένη λίστα που γνωρίζει ο server και η εφαρμογή.
Στα δεδομένα του μηνύματος συμπεριλαμβάνονται ό,τι άλλες πληροφορίες είναι απαραίτητες για τον πλήρη προσδιορισμό της ενέργειας που πρέπει να εκτελεστεί.
Παρακάτω περιγράφουμε όλους τους τύπους των μηνυμάτων μαζί με τη λειτουργία τους.

\begin{description}
    \item[Νέος πεζός/οδηγός:] Στέλνεται από τον χρήστη μόλις αυτός συνδέεται στην εφαρμογή ως πεζός ή οδηγός. Μαζί με το μήνυμα στέλνονται και οι συντεταγμένες του χρήστη, καθώς και το όχημα του αν πρόκειται για οδηγό. Ο server προσθέτει τον χρήστη στη λίστα των πεζών ή στη λίστα των οδηγών αντίστοιχα, και ειδοποιεί τον χρήστη για την επιτυχή προσθήκη του στην υπηρεσία.
    \item[Παύση πεζού/οδηγού:] Στέλνεται από τον χρήστη όταν επιθυμεί να διακόψει την υπηρεσία. Ο πεζός ή οδηγός αφαιρείται από την αντίστοιχη λίστα. Σε περίπτωση που ο χρήστης βρίσκεται εν μέσω διαδρομής τότε αυτή ακυρώνεται, και ειδοποιούνται οι χρήστες που πρέπει· αν πρόκειται για παύση οδηγού τότε ενημερώνονται όλοι οι επιβάτες του, ενώ αν πρόκειται για παύση επιβάτη τότε ενημερώνεται ο οδηγός του.
    \item[Ενημέρωση πεζού/οδηγού:] Στέλνεται κάθε φορά που ένας ενεργός χρήστης μετακινείται. Ταυτόχρονα στέλνεται το στίγμα του χρήστη. Ο server ενημερώνει τις συντεταγμένες που έχει αποθηκεύσει για τον χρήστη, και ειδοποιεί τους άλλους συμμετέχοντες χρήστες για τη νέα θέση του.
    \item[Ερώτηση για ύπαρξη πεζών:] Στέλνεται από έναν νέο οδηγό όταν αυτός επιθυμεί να μάθει αν υπάρχουν διαθέσιμοι πεζοί που αναμένουν στη στάση. Ο server απαντάει καταφατικά αν υπάρχουν όντως πεζοί.
    \item[Αναζήτηση επιβατών:] Στέλνεται από έναν οδηγό όταν αυτός δηλώνει την επιθυμία του να δεχτεί επιβάτες για μεταφορά. Ο server επιλέγει έναν αριθμό από πεζούς που βρίσκονται στη στάση και τους στέλνει αίτημα για την αποδοχή του οδηγού.
    \item[Αποδοχή οδηγού:] Στέλνεται από έναν πεζό ο οποίος αποδέχεται τον οδηγό του. Ο server επιβεβαιώνει την ανάθεση του οδηγού στον πεζό, και ενημερώνει τον οδηγό για τον νέο επιβάτη του.
    \item[Εγκατάληψη πεζού:] Στέλνεται από έναν πεζό στον οποίο έχει ανατεθεί οδηγός, αλλά του οποίου ο οδηγός προσπέρασε την στάση χωρίς να τον παραλάβει. Ο server αφαιρεί τον πεζό από τους επιβάτες του οδηγού και αρχίζει αμέσως να αναζητεί νέο οδηγό για εκείνον.
    \item[Άφιξη στον προορισμό:] Στέλνεται από τον οδηγό όταν αυτός φτάσει στην σχολή με τους επιβάτες του. Ο server τερματίζει τη διαδρομή αφαιρόντας τον οδηγό και τους επιβάτες από τις αντίστοιχες λίστες.
    \item[Αποστολή αξιολόγησης:] Στέλνεται από χρήστη που επιθυμεί να βαθμολογήσει την εμπειρία του με έναν οδηγό ή πεζό. Τα δεδομένα περιλαμβάνουν το ΑΜ του υπό αξιολόγηση χρήστη μαζί με την τιμή της βαθμολογίας. Ο server ελέγχει την εγκυρότητα των στοιχείων\footnote{Συγκεκριμένα ελέγχεται αν η τιμή της βαθμολογίας κυμαίνεται μεταξύ του 1 και του 5, και το αν έχει ως στόχο τον οδηγό/επιβάτη με τον οποίο ο χρήστης μόλις ολοκλήρωσε την διαδρομή του.} και ενημερώνει την τιμή της βαθμολογίας του αντίστοιχου χρήστη στη βάση δεδομένων.
    \item[Προσθήκη/ενημέρωση/αφαίρεση οχήματος:] Στέλνεται από χρήστη που επιθυμεί να αλλάξει ένα από τα διαθέσιμα οχήματά του. Τα δεδομένα αποτελούν όλα τα στοιχεία του εν λόγω οχήματος, τα οποία ο server ελέγχει πριν προσθέσει το όχημα στη βάση δεδομένων.
    \item[Προσθήκη/ενημέρωση/αφαίρεση φωτογραφίας:] Στέλνεται από χρήστη που επιθυμεί να αλλάξει την φωτογραφία στο προφίλ του. Ο server κατεβάζει την φωτογραφία του χρήστη στο δίσκο και αφού ελέγξει την καταλληλότητά της μέσω ενός φίλτρου/neural network, την θέτει ως την φωτογραφία του χρήστη στη βάση δεδομένων.
    \item[Αποσύνδεση:] Στέλνεται από τον χρήστη όταν αυτός κλείνει την εφαρμογή ή αποσυνδέεται από τον λογαριασμό του. Ο server διακόπτει τη τρέχουσα διαδρομή του χρήστη και τερματίζει τη σύνδεση του.
\end{description}

\end{document}