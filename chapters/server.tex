\documentclass[../thesis.tex]{subfiles}

\begin{document}

Η φύση της εφαρμογής επιβάλλει την ύπαρξη ενός κεντρικού server ο οποίος συντονίζει τις διάφορες λειτουργίες.
Οι πεζοί και οι οδηγοί χρειάζεται να επικοινωνούν μεταξύ τους σε πραγματικό χρόνο, και στην επικοινωνία αυτή μεσολαβεί ο server: ο κάθε χρήστης στέλνει όλα τα μηνύματα του στον server, ο server με τη σειρά του τα επεξεργάζεται αλλάζοντας αναλόγως την εσωτερική του κατάσταση, και έπειτα προωθεί περαιτέρω μηνύματα στους απαραίτητους χρήστες.

Για την εφαρμογή του server χρησιμοποιήσαμε το Node.js.
Η εφαρμογή του server αποτελείται από δύο υπηρεσίες:
\begin{itemize}
    \item την κύρια υπηρεσία API που χειρίζεται όλη την εσωτερική λογική και με την οποία οι χρήστες επικοινωνούν
    \item την υπηρεσία που χειρίζεται τα αρχεία πολυμέσων, και συγκεκριμένα τις εικόνες που ανεβάζουν οι χρήστες
\end{itemize}
Ο διαχωρισμός αυτός έγινε καθώς διαμερίζοντας τον server σε ειδικευμένα μέρη μπορούμε να πετύχουμε καλύτερη επίδοση.
Αποθηκεύοντας ξεχωριστά όλα τα αρχεία πολυμέσων (αρχεία σχετικά μεγάλου μεγέθους) και μεταφέροντας την αρμοδιότητα διαχείρισής τους σε άλλο server, ελαφραίνουμε τον φόρτο από την κύρια υπηρεσία μας και πετυχαίνουμε μικρότερο latency.

Για τον web server χρησιμοποιήσαμε το Nginx, κυρίως ως reverse proxy.
Το Nginx βρίσκεται "μπροστά" από το Node.js και δέχεται πρώτο όλα τα requests που φτάνουν στον server.
Μέσω ενός reverse proxy, ανακατευθύνουμε τα requests στη θύρα της υπηρεσίας API ή της υπηρεσίας πολυμέσων ανάλογα με το URL, καταφέρνοντας με αυτόν τον τρόπο να έχουμε το ίδιο domain και για τους δύο server.
Ο server Nginx είναι επίσης υπεύθυνος για την αποστολή των στατικών αρχείων στον χρήστη (στην προκειμένη περίπτωση αρχεία εικόνων), μία λειτουργία στην οποία υπερέχει του Node.js ως προς την ταχύτητα.
Τέλος, μέσω του Nginx ενσωματώνουμε την κρυπτογράφηση SSL/TLS για την ασφαλή επικοινωνία των χρηστών με τον server μέσω HTTPS, με πιστοποιητικό που λαμβάνουμε από τη γνωστή αρχή πιστοποίησης \textit{Let's Encrypt}.

Τα δεδομένα των χρηστών πρέπει να συγχρονίζονται μεταξύ των συσκευών στις οποίες συνδέονται, επομένως είναι απαραίτητη η αποθήκευσή τους στον server.
Για αυτόν τον σκοπό χρησιμοποιούμε μία σχεσιακή βάση δεδομένων MySQL.
Η βάση αποτελείται από δύο tables, ένα για τις πληροφορίες των χρηστών και ένα για τα οχήματα.
Συγκεκριμένα οι πληροφορίες που συγκρατούνται στη βάση για τον κάθε χρήστη αποτελούνται από τον αριθμό μητρώου του (ο οποίος λειτουργεί ως το στοιχείο ταυτοποίησης), τη βαθμολογία του, και προαιρετικά μία φωτογραφία.
Όσον αφορά τα οχήματα, αποθηκεύεται ο ΑΜ του χρήστη στον οποίο αυτό ανήκει, το μοντέλο, και ο αριθμός πινακίδας του, ενώ προαιρετικά μπορεί να συμπεριληφθεί το χρώμα και μία φωτογραφία.
Έχοντας αποθηκεύσει τα δεδομένα στη βάση, κάθε φορά που ένας χρήστης συνδέεται στην εφαρμογή τα υπάρχοντα στοιχεία του στέλνονται από τον server στη συσκευή του, ενώ ό,τι νέα στοιχεία προκύψουν στέλνονται στον server για την ανανέωση της βάσης.

Η επικοινωνία client-server επιτυγχάνεται μέσα από την τεχνολογία WebSocket.
Ο χρήστης της εφαρμογής, αφού ταυτοποιηθεί ως φοιτητής από την υπηρεσία της σχολής, ανοίγει σύνδεση WebSocket με τον server.
Η σύνδεση αυτή διαρκεί για όλη τη διάρκεια της συνεδρίας, και τερματίζεται μόλις ο χρήστης αποσυνδεθεί.
Το πρωτόκολλο WebSocket χρησιμοποιήθηκε καθώς αξιολογήθηκε ως το καταλληλότερο για τις απαιτήσεις της εφαρμογής ως προς τη real-time επικοινωνία.
Τα WebSockets υπερέχουν τόσο της κλασσικής τεχνολογίας του long polling, καθώς παρέχουν άμεση και αμφίδρομη επικοινωνία με μικρές καθυστερήσεις, αλλά και της τεχνολογίας WebRTC, καθώς προσφέρουν εγγυήσεις για την επιτυχή αποστολή των πακέτων χωρίς σφάλματα.

Όπως αναφέραμε προηγουμένως, το backend αποτελείται από δύο ανεξάρτητα μέρη, έναν κλασσικό HTTP server για τα αρχεία πολυμέσων, και έναν WebSocket server για το API.
Ο media server ανταποκρίνεται απλά σε GET/POST/DELETE requests με τον ευνόητο τρόπο, επιστρέφοντας/ανεβάζοντας/διαγράφοντας αρχεία εικόνων αντιστοίχως.
Το μόνο στοιχείο που αξίζει να σημειωθεί είναι η ύπαρξη ελέγχων για την προστασία έναντι κακόβουλων ενεργειών, συγκεκριμένα η ύπαρξη ανώτατου ορίου των 2MB για τα αρχεία που ανεβάζονται\footnote{Στην πραγματικότητα το όριο των 2MB επιβάλλεται από το Nginx για όλα τα αιτήματα που φτάνουν στον server}, η απαγόρευση αρχείων που δεν έχουν τύπο εικόνας PNG/JPEG, και φυσικά η απαγόρευση ανεβάσματος αρχείων από χρήστες που δεν είναι πιστοποιημένοι.
Η λειτουργία του API server είναι πιο ενδιαφέρουσα.
Για τη σύνδεση μέσω WebSocket απαιτείται πρώτα η αποστολή ενός HTTP upgrade request από τον client προς τον server, ακολουθόμενη από την αποδοχή της αίτησης από τον server (opening handshake).
Σε αυτή την εναρκτήρια αίτηση, ο χρήστης στέλνει με τη μορφή JWT (JSON Web Token) τα στοιχεία της ταυτότητάς του όπως αυτά παραχωρήθηκαν από τον Identity Provider της σχολής, και ο server ελέγχει την εγκυρότητά τους.
Αν για οποιονδήποτε λόγο ο server κρίνει την ταυτότητα του χρήστη ως μη έγκυρη\footnote{Η ταυτότητα ενός χρήστη κρίνεται ως μη έγκυρη αν το JWT έχει λήξει, αν δεν περιέχει όλα τα ταυτοποιητικά στοιχεία που είναι απαραίτητα, αν η υπογραφή του δεν αντιστοιχεί στον Identity Provider της σχολής, ή αν το JWT απουσιάζει εντελώς}, τότε η σύνδεση τερματίζεται αμέσως.
Αν η ταυτότητα του χρήστη είναι έγκυρη, τότε η σύνδεση επιτυγχάνεται και ο χρήστης έχει πλέον τη δυνατότητα να επικοινωνήσει με το API του server μέσω της εφαρμογής.
Κατά την επιτυχή σύνδεση του χρήστη, ο server αρχικά αναζητά τον χρήστη στην βάση δεδομένων.
Αν ο χρήστης συνδέεται στην εφαρμογή για πρώτη φορά και επομένως δεν υπάρχει ο αντίστοιχος λογαριασμός στη βάση, τότε δημιουργείται ένας νέος άδειος λογαριασμός· διαφορετικά ο server διαβάζει τα αποθηκευμένα στοιχεία από τη βάση και τα στέλνει πίσω στον χρήστη.
Από το σημείο αυτό και πέρα, ο server αναμένει την αποστολή μηνυμάτων από την εφαρμογή, εκτελώντας τις ανάλογες λειτουργίες κατά την λήψη τους, και στέλνοντας ενδεχομένως άλλα μηνύματα πίσω στον χρήστη.
Το κάθε μήνυμα που ανταλλάσσεται μεταξύ εφαρμογής και server είναι ένα αντικείμενο JSON το οποίο περιέχει δύο πεδία: τον τύπο και τα δεδομένα.
Ο τύπος του κάθε μηνυμάτος υποδεικνύει την ενέργεια που επιθυμεί να λάβει ο χρήστης, και ανήκει σε μία προκαθορισμένη λίστα που γνωρίζει ο server και η εφαρμογή.
Στα δεδομένα του μηνύματος συμπεριλαμβάνονται ό,τι άλλες πληροφορίες είναι απαραίτητες για τον πλήρη προσδιορισμό της ενέργειας που πρέπει να εκτελεστεί.
Παρακάτω περιγράφουμε όλους τους τύπους των μηνυμάτων μαζί με τη λειτουργία τους.

\end{document}